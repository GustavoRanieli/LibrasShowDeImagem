!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("@tensorflow/tfjs-converter"),require("@tensorflow/tfjs-core")):"function"==typeof define&&define.amd?define(["exports","@tensorflow/tfjs-converter","@tensorflow/tfjs-core"],n):n((t=t||self).handpose={},t.tf,t.tf)}(this,function(t,u,g){"use strict";function d(t,s,a,u){return new(a=a||Promise)(function(e,n){function o(t){try{r(u.next(t))}catch(t){n(t)}}function i(t){try{r(u.throw(t))}catch(t){n(t)}}function r(t){var n;t.done?e(t.value):((n=t.value)instanceof a?n:new a(function(t){t(n)})).then(o,i)}r((u=u.apply(t,s||[])).next())})}function P(o,i){var r,s,a,u={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},t={next:n(0),throw:n(1),return:n(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function n(e){return function(t){var n=[e,t];if(r)throw new TypeError("Generator is already executing.");for(;u;)try{if(r=1,s&&(a=2&n[0]?s.return:n[0]?s.throw||((a=s.return)&&a.call(s),0):s.next)&&!(a=a.call(s,n[1])).done)return a;switch(s=0,(n=a?[2&n[0],a.value]:n)[0]){case 0:case 1:a=n;break;case 4:return u.label++,{value:n[1],done:!1};case 5:u.label++,s=n[1],n=[0];continue;case 7:n=u.ops.pop(),u.trys.pop();continue;default:if(!(a=0<(a=u.trys).length&&a[a.length-1])&&(6===n[0]||2===n[0])){u=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3]))u.label=n[1];else if(6===n[0]&&u.label<a[1])u.label=a[1],a=n;else{if(!(a&&u.label<a[2])){a[2]&&u.ops.pop(),u.trys.pop();continue}u.label=a[2],u.ops.push(n)}}n=i.call(o,u)}catch(t){n=[6,t],s=0}finally{r=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}}}function h(t){return[Math.abs(t.endPoint[0]-t.startPoint[0]),Math.abs(t.endPoint[1]-t.startPoint[1])]}function y(t){return[t.startPoint[0]+(t.endPoint[0]-t.startPoint[0])/2,t.startPoint[1]+(t.endPoint[1]-t.startPoint[1])/2]}function i(t,n){void 0===n&&(n=1.5);var e=y(t),o=h(t),n=[n*o[0]/2,n*o[1]/2];return{startPoint:[e[0]-n[0],e[1]-n[1]],endPoint:[e[0]+n[0],e[1]+n[1]],palmLandmarks:t.palmLandmarks}}function r(t){var n=y(t),e=h(t),e=Math.max.apply(Math,e)/2;return{startPoint:[n[0]-e,n[1]-e],endPoint:[n[0]+e,n[1]+e],palmLandmarks:t.palmLandmarks}}function s(t,n){var e=[t.endPoint[0]-t.startPoint[0],t.endPoint[1]-t.startPoint[1]],e=[e[0]*n[0],e[1]*n[1]];return{startPoint:[t.startPoint[0]+e[0],t.startPoint[1]+e[1]],endPoint:[t.endPoint[0]+e[0],t.endPoint[1]+e[1]],palmLandmarks:t.palmLandmarks}}n.prototype.normalizeBoxes=function(o){var i=this;return g.tidy(function(){var t=g.slice(o,[0,0],[-1,2]),n=g.slice(o,[0,2],[-1,2]),t=g.add(g.div(t,i.inputSizeTensor),i.anchorsTensor),n=g.div(n,i.doubleInputSizeTensor),e=g.mul(g.sub(t,n),i.inputSizeTensor),t=g.mul(g.add(t,n),i.inputSizeTensor);return g.concat2d([e,t],1)})},n.prototype.normalizeLandmarks=function(n,e){var o=this;return g.tidy(function(){var t=g.add(g.div(g.reshape(n,[-1,7,2]),o.inputSizeTensor),o.anchors[e]);return g.mul(t,o.inputSizeTensor)})},n.prototype.getBoundingBoxes=function(m){return d(this,void 0,void 0,function(){var n,e,o,i,r,s,a,u,d,h,c,l,f,p=this;return P(this,function(t){switch(t.label){case 0:return n=g.tidy(function(){return g.mul(g.sub(m,.5),2)}),"webgl"===g.getBackend()?(i=g.env().get("WEBGL_PACK_DEPTHWISECONV"),g.env().set("WEBGL_PACK_DEPTHWISECONV",!0),e=this.model.predict(n),g.env().set("WEBGL_PACK_DEPTHWISECONV",i)):e=this.model.predict(n),o=g.squeeze(e),i=g.tidy(function(){return g.squeeze(g.sigmoid(g.slice(o,[0,0],[-1,1])))}),r=g.slice(o,[0,1],[-1,4]),s=this.normalizeBoxes(r),u=console.warn,console.warn=function(){},a=g.image.nonMaxSuppression(s,i,1,this.iouThreshold,this.scoreThreshold),console.warn=u,[4,a.array()];case 1:return(u=t.sent(),d=[n,e,a,o,s,r,i],0===u.length)?(d.forEach(function(t){return t.dispose()}),[2,null]):(h=u[0],c=g.slice(s,[h,0],[1,-1]),l=g.slice(o,[h,5],[1,14]),f=g.tidy(function(){return g.reshape(p.normalizeLandmarks(l,h),[-1,2])}),d.push(l),d.forEach(function(t){return t.dispose()}),[2,{boxes:c,palmLandmarks:f}])}})})},n.prototype.estimateHandBounds=function(c){return d(this,void 0,void 0,function(){var o,i,r,s,a,u,d,h=this;return P(this,function(t){switch(t.label){case 0:return o=c.shape[1],i=c.shape[2],r=g.tidy(function(){return g.div(g.image.resizeBilinear(c,[h.width,h.height]),255)}),[4,this.getBoundingBoxes(r)];case 1:return null===(s=t.sent())?(r.dispose(),[2,null]):(u=s.boxes.arraySync(),a=u[0].slice(0,2),u=u[0].slice(2,4),d=s.palmLandmarks.arraySync(),r.dispose(),s.boxes.dispose(),s.palmLandmarks.dispose(),[2,(n={startPoint:a,endPoint:u,palmLandmarks:d},e=[i/this.width,o/this.height],{startPoint:[n.startPoint[0]*e[0],n.startPoint[1]*e[1]],endPoint:[n.endPoint[0]*e[0],n.endPoint[1]*e[1]],palmLandmarks:n.palmLandmarks.map(function(t){return[t[0]*e[0],t[1]*e[1]]})})])}var n,e})})};var c=n;function n(t,n,e,o,i,r){this.model=t,this.width=n,this.height=e,this.iouThreshold=i,this.scoreThreshold=r,this.anchors=o.map(function(t){return[t.x_center,t.y_center]}),this.anchorsTensor=g.tensor2d(this.anchors),this.inputSizeTensor=g.tensor1d([n,e]),this.doubleInputSizeTensor=g.tensor1d([2*n,2*e])}var m={thumb:[1,2,3,4],indexFinger:[5,6,7,8],middleFinger:[9,10,11,12],ringFinger:[13,14,15,16],pinky:[17,18,19,20],palmBase:[0]};function b(t,n){n=Math.PI/2-Math.atan2(-(n[1]-t[1]),n[0]-t[0]);return n-2*Math.PI*Math.floor((n+Math.PI)/(2*Math.PI))}function o(t,n){return[[1,0,t],[0,1,n],[0,0,1]]}function l(t,n){for(var e=0,o=0;o<t.length;o++)e+=t[o]*n[o];return e}function a(t,n){for(var e=[],o=t.length,i=0;i<o;i++){e.push([]);for(var r=0;r<o;r++)e[i].push(l(t[i],function(t,n){for(var e=[],o=0;o<t.length;o++)e.push(t[o][n]);return e}(n,r)))}return e}function x(t,n){var e=Math.cos(t),t=Math.sin(t),t=a(o(n[0],n[1]),[[e,-t,0],[t,e,0],[0,0,1]]);return a(t,o(-n[0],-n[1]))}function f(t,n){return[l(t,n[0]),l(t,n[1])]}var e=[0,-.4],p=[0,-.1],v=[0,5,9,13,17,1,2],k=(w.prototype.getBoxForPalmLandmarks=function(t,n){t=t.map(function(t){return f(t.concat([1]),n)});return i(r(s(this.calculateLandmarksBoundingBox(t),e)),3)},w.prototype.getBoxForHandLandmarks=function(t){for(var n=i(r(s(this.calculateLandmarksBoundingBox(t),p)),1.65),e=[],o=0;o<v.length;o++)e.push(t[v[o]].slice(0,2));return n.palmLandmarks=e,n},w.prototype.transformRawCoords=function(t,n,e,o){var i=this,r=h(n),s=[r[0]/this.meshWidth,r[1]/this.meshHeight],r=t.map(function(t){return[s[0]*(t[0]-i.meshWidth/2),s[1]*(t[1]-i.meshHeight/2),t[2]]}),a=x(e,[0,0]),t=r.map(function(t){return f(t,a).concat([t[2]])}),o=(r=[[(e=o)[0][0],e[1][0]],[e[0][1],e[1][1]]],e=[e[0][2],e[1][2]],e=[-l(r[0],e),-l(r[1],e)],[r[0].concat(e[0]),r[1].concat(e[1]),[0,0,1]]),r=y(n).concat([1]),u=[l(r,o[0]),l(r,o[1])];return t.map(function(t){return[t[0]+u[0],t[1]+u[1],t[2]]})},w.prototype.estimateHand=function(v){return d(this,void 0,void 0,function(){var s,a,u,d,h,c,l,f,p,m;return P(this,function(t){switch(t.label){case 0:return!0!==(s=this.shouldUpdateRegionsOfInterest())?[3,2]:[4,this.boundingBoxDetector.estimateHandBounds(v)];case 1:return null===(a=t.sent())?(v.dispose(),this.regionsOfInterest=[],[2,null]):(this.updateRegionsOfInterest(a,!0),this.runsWithoutHandDetector=0,[3,3]);case 2:this.runsWithoutHandDetector++,t.label=3;case 3:return(a=this.regionsOfInterest[0],u=b(a.palmLandmarks[0],a.palmLandmarks[2]),d=y(a),m=[d[0]/v.shape[2],d[1]/v.shape[1]],m=g.image.rotateWithOffset(v,u,0,m),d=x(-u,d),h=!0===s?this.getBoxForPalmLandmarks(a.palmLandmarks,d):a,n=h,e=m,o=[this.meshWidth,this.meshHeight],i=e.shape[1],r=e.shape[2],i=[[n.startPoint[1]/i,n.startPoint[0]/r,n.endPoint[1]/i,n.endPoint[0]/r]],p=g.image.cropAndResize(e,i,[0],o),l=g.div(p,255),p.dispose(),m.dispose(),"webgl"===g.getBackend()?(p=g.env().get("WEBGL_PACK_DEPTHWISECONV"),g.env().set("WEBGL_PACK_DEPTHWISECONV",!0),c=this.meshDetector.predict(l),g.env().set("WEBGL_PACK_DEPTHWISECONV",p)):c=this.meshDetector.predict(l),m=c[0],p=c[1],l.dispose(),l=m.dataSync()[0],m.dispose(),l<this.detectionConfidence)?(p.dispose(),this.regionsOfInterest=[],[2,null]):(m=g.reshape(p,[-1,3]),f=m.arraySync(),p.dispose(),m.dispose(),p=this.transformRawCoords(f,h,u,d),m=this.getBoxForHandLandmarks(p),this.updateRegionsOfInterest(m,!1),[2,{landmarks:p,handInViewConfidence:l,boundingBox:{topLeft:m.startPoint,bottomRight:m.endPoint}}])}var n,e,o,i,r})})},w.prototype.calculateLandmarksBoundingBox=function(t){var n=t.map(function(t){return t[0]}),t=t.map(function(t){return t[1]});return{startPoint:[Math.min.apply(Math,n),Math.min.apply(Math,t)],endPoint:[Math.max.apply(Math,n),Math.max.apply(Math,t)]}},w.prototype.updateRegionsOfInterest=function(t,n){var e,o,i,r,s,a,u,d,h,c;n?this.regionsOfInterest=[t]:(null!=(e=this.regionsOfInterest[n=0])&&null!=e.startPoint&&(o=(i=t.startPoint)[0],i=i[1],r=(s=t.endPoint)[0],s=s[1],a=(h=e.startPoint)[0],h=h[1],u=(d=e.endPoint)[0],d=d[1],c=Math.max(o,a),h=Math.max(i,h),n=(c=(Math.min(r,u)-c)*(Math.min(s,d)-h))/((r-o)*(s-i)+(u-a)*(d-i)-c)),this.regionsOfInterest[0]=.8<n?e:t)},w.prototype.shouldUpdateRegionsOfInterest=function(){return this.regionsOfInterest.length!==this.maxHandsNumber||this.runsWithoutHandDetector>=this.maxContinuousChecks},w);function w(t,n,e,o,i,r){this.boundingBoxDetector=t,this.meshDetector=n,this.meshWidth=e,this.meshHeight=o,this.maxContinuousChecks=i,this.detectionConfidence=r,this.regionsOfInterest=[],this.runsWithoutHandDetector=0,this.maxHandsNumber=1}L.getAnnotations=function(){return m},L.prototype.estimateHands=function(f,p){return void 0===p&&(p=!1),d(this,void 0,void 0,function(){var r,s,a,u,d,h,c,l;return P(this,function(t){switch(t.label){case 0:return r=(i=f)instanceof g.Tensor?[i.shape[0],i.shape[1]]:[i.height,i.width],r=r[1],s=g.tidy(function(){return f instanceof g.Tensor||(f=g.browser.fromPixels(f)),g.expandDims(g.cast(f,"float32"))}),[4,this.pipeline.estimateHand(s)];case 1:if(a=t.sent(),s.dispose(),null===a)return[2,[]];for(u=a,!0===p&&(n=r,e=(i=a).handInViewConfidence,o=i.landmarks,i=i.boundingBox,u={handInViewConfidence:e,landmarks:o.map(function(t){return[n-1-t[0],t[1],t[2]]}),boundingBox:{topLeft:[n-1-i.topLeft[0],i.topLeft[1]],bottomRight:[n-1-i.bottomRight[0],i.bottomRight[1]]}}),d={},h=0,c=Object.keys(m);h<c.length;h++)l=c[h],d[l]=m[l].map(function(t){return u.landmarks[t]});return[2,[{handInViewConfidence:u.handInViewConfidence,boundingBox:u.boundingBox,landmarks:u.landmarks,annotations:d}]]}var n,e,o,i})})};var B=L;function L(t){this.pipeline=t}t.HandPose=B,t.load=function(t){var n=(t=void 0===t?{}:t).maxContinuousChecks,i=void 0===n?1/0:n,r=void 0===(n=t.detectionConfidence)?.8:n,s=void 0===(n=t.iouThreshold)?.3:n,a=void 0===(n=t.scoreThreshold)?.5:n;return d(this,void 0,void 0,function(){var n,e,o;return P(this,function(t){switch(t.label){case 0:return[4,Promise.all([function(){return d(this,void 0,void 0,function(){return P(this,function(t){return[2,g.util.fetch("https://tfhub.dev/mediapipe/tfjs-model/handskeleton/1/default/1/anchors.json?tfjs-format=file").then(function(t){return t.json()})]})})}(),function(){return d(this,void 0,void 0,function(){return P(this,function(t){return[2,u.loadGraphModel("https://tfhub.dev/mediapipe/tfjs-model/handdetector/1/default/1",{fromTFHub:!0})]})})}(),function(){return d(this,void 0,void 0,function(){return P(this,function(t){return[2,u.loadGraphModel("https://tfhub.dev/mediapipe/tfjs-model/handskeleton/1/default/1",{fromTFHub:!0})]})})}()])];case 1:return n=t.sent(),o=n[0],e=n[1],n=n[2],e=new c(e,256,256,o,s,a),o=new k(e,n,256,256,i,r),[2,new B(o)]}})})},Object.defineProperty(t,"__esModule",{value:!0})});